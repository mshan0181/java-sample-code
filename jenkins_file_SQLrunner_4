pipeline {
    agent { label 'master' }    
    stages {
        stage('Download') {
            steps {
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'userDefined', script: '',scriptContent: 'select * from v$version'])
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'userDefined', script: '',scriptContent: 'select name from v$database'])
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'file', script: 'tablespace_usage_listing.sql',scriptContent: ''])
                   }
                }

          stage('Email-attachement') {
            when { expression { return fileExists ('tablespace_usage_logfile.html') } }  
            steps {                                               
                   emailext mimeType: 'text/html',
                   body: '${FILE, path="tablespace_usage_logfile.html"}',
                   subject: "Tablespace alert  -Critical threshold reaching 90% ",
                   to: 'mshan011181@gmail.com'                   
                  }
              } 
                 stage('Delete tablespace_usage_logfile.html file') {
                   steps {
                           script {
                               if (fileExists('tablespace_usage_logfile.html')) {
                                  new File('tablespace_usage_logfile.html').delete()
                                       }  else {
                                          echo 'No file found'
                                                 } 
                                  }
                         }         
                     }
        }
}
