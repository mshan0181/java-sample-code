pipeline {
    agent { label 'master' }    
    stages {
         stage('Download') {
            steps {
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'userDefined', script: '',scriptContent: 'select * from v$version'])
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'userDefined', script: '',scriptContent: 'select name from v$database'])
                step([$class: 'SQLPlusRunnerBuilder',credentialsId:'shandb-priv-id', instance:'client_access',scriptType:'file', script: 'tablespace_usage_listing.sql',scriptContent: ''])
                   }
                }
          stage('Email-attachement') {
            when { expression { return fileExists ('tablespace_usage_logfile.html') } }  
            steps {     
                       script {  
                               bat '''
                               type tablespace_usage_logfile.log | find /c "TABLESPACE_NAME" > temp.txt'  
                               set /p TABLESPACE_PARAM=<temp.txt
                               type temp.txt
                               set zero=0    
                               '''                  
                               when { expression { params.TABLESPACE_PARAM == 0} }
                               echo 'There are no records in file with no Tablespace details recorded for Alert'
                               when { expression { params.TABLESPACE_PARAM == 1} }
                                             emailext mimeType: 'text/html',
                                              body: '${FILE, path="tablespace_usage_logfile.html"}',
                                              subject: "Tablespace alert  -Critical threshold reaching 90% ",
                                              to: 'mshan011181@gmail.com'                               
                                                 }  
                              }                 
                  }
             } 
                 
   }
}
